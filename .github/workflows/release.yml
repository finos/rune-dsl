name: Publish package to the Maven Central Repository

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Publish to Central
        uses: ./.github/actions/maven-build
        with:
          set-version: ${{ github.event.release.tag_name }}
          build-command: install org.sonatype.central:central-publishing-maven-plugin:0.7.0:publish -P release
        env:
          CI_DEPLOY_USERNAME: ${{ secrets.CI_DEPLOY_USERNAME_CENTRAL }}
          CI_DEPLOY_PASSWORD: ${{ secrets.CI_DEPLOY_PASSWORD_CENTRAL }}
          RUNE_GPG_PRIVATE_KEY: ${{ secrets.RUNE_GPG_PRIVATE_KEY }}
          RUNE_GPG_PASSPHRASE: ${{ secrets.RUNE_GPG_PASSPHRASE }}

  wait-for-release:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Poll for release availability
        run: |
          GROUP_ID="org/finos/rune"
          VERSION="${{ github.event.release.tag_name }}"

          MODULES=(
            "rune-runtime"
            "rune-ide"
            "rune-maven-plugin"
            "rune-testing"
            "rune-tools"
            "rune-xcore-plugin-dependencies"
          )

          echo "Polling for all modules in version $VERSION"

          for i in {1..30}; do
            ALL_OK=true
            for ARTIFACT_ID in "${MODULES[@]}"; do
              URL="https://repo1.maven.org/maven2/$GROUP_ID/$ARTIFACT_ID/$VERSION/$ARTIFACT_ID-$VERSION.jar"
              if ! curl --silent --head --fail "$URL" > /dev/null; then
                echo "Missing $ARTIFACT_ID-$VERSION.jar"
                ALL_OK=false
              else
                echo "Found $ARTIFACT_ID-$VERSION.jar"
              fi
            done

            if [ "$ALL_OK" = true ]; then
              echo "All modules are available in Maven Central"
              exit 0
            fi

            echo "Not all artifacts available yet... waiting 20s"
            sleep 20
          done

          echo "Release not available after 10 minutes"
          exit 1

  backport-publish:
    needs: wait-for-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Publish Rosetta Backport
        uses: ./.github/actions/maven-build
        with:
          working-directory: rosetta-backport
          set-version: ${{ github.event.release.tag_name }}
          build-command: install org.sonatype.central:central-publishing-maven-plugin:0.7.0:publish -P release
        env:
          CI_DEPLOY_USERNAME: ${{ secrets.CI_DEPLOY_USERNAME }}
          CI_DEPLOY_PASSWORD: ${{ secrets.CI_DEPLOY_PASSWORD }}
          RUNE_GPG_PRIVATE_KEY: ${{ secrets.RUNE_GPG_PRIVATE_KEY }}
          RUNE_GPG_PASSPHRASE: ${{ secrets.RUNE_GPG_PASSPHRASE }}
